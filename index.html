<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENGO651 Lab 5 - IoT Geoweb App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; }
        body { font-family: Arial, sans-serif; padding: 10px; }
        .controls { margin-bottom: 10px; }
        input, button { margin: 5px; }
    </style>
</head>
<body>
    <div class="controls">
        <label>Broker Host: <input type="text" id="host" value="test.mosquitto.org"></label><br>
        <label>Port: <input type="number" id="port" value="8081"></label><br>
        <button id="startBtn">Start</button>
        <button id="endBtn" disabled>End</button>
        <button id="shareBtn" disabled>Share My Status</button>
    </div>
    <div id="status"></div>
    <div id="map"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Replace with your name (e.g., "john_doe")
        const YOUR_NAME = "Sherry Chalotra"; 
        const COURSE_CODE = "ENGO651";
        const TOPIC = `${COURSE_CODE}/${YOUR_NAME}/my_temperature`;

        let client = null;
        let map = null;
        let marker = null;

        // Initialize Leaflet map
        function initMap(lat = 51.505, lng = -0.09) { // Default to London
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Get marker color based on temperature
        function getMarkerColor(temp) {
            if (temp < 10) return 'blue';
            if (temp < 30) return 'green';
            return 'red';
        }

        // Update map with new location and temperature
        function updateMap(geojson) {
            const { coordinates } = geojson.geometry;
            const temp = geojson.properties.temperature;
            const [lng, lat] = coordinates;

            if (marker) map.removeLayer(marker);
            marker = L.circleMarker([lat, lng], {
                radius: 8,
                color: getMarkerColor(temp),
                fillOpacity: 0.8
            }).addTo(map);
            marker.bindPopup(`Temperature: ${temp}°C`).openPopup();
            map.setView([lat, lng], 13);
        }

        // Generate GeoJSON with current location and random temperature
        function getGeoJSON(callback) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const geojson = {
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: [position.coords.longitude, position.coords.latitude]
                        },
                        properties: {
                            temperature: Math.floor(Math.random() * 100) - 40 // Random -40 to 60
                        }
                    };
                    callback(geojson);
                },
                (error) => {
                    document.getElementById('status').innerText = "Geolocation error: " + error.message;
                }
            );
        }

        // MQTT Connection
        document.getElementById('startBtn').addEventListener('click', () => {
            const host = document.getElementById('host').value;
            const port = parseInt(document.getElementById('port').value);

            client = new Paho.MQTT.Client(host, port, "clientId_" + parseInt(Math.random() * 100));
            client.onConnectionLost = () => {
                document.getElementById('status').innerText = "Disconnected. Reconnecting...";
                setTimeout(() => client.connect({ onSuccess: onConnect }), 2000); // Auto-reconnect
            };
            client.onMessageArrived = (message) => {
                const geojson = JSON.parse(message.payloadString);
                updateMap(geojson);
            };

            client.connect({
                onSuccess: () => {
                    document.getElementById('status').innerText = "Connected to " + host;
                    client.subscribe(TOPIC);
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('endBtn').disabled = false;
                    document.getElementById('shareBtn').disabled = false;
                    document.getElementById('host').disabled = true;
                    document.getElementById('port').disabled = true;
                    if (!map) initMap(); // Initialize map on first connect
                },
                onFailure: (err) => {
                    document.getElementById('status').innerText = "Connection failed: " + err.errorMessage;
                },
                useSSL: true // Required for test.mosquitto.org WebSockets
            });
        });

        // End Connection
        document.getElementById('endBtn').addEventListener('click', () => {
            if (client) {
                client.disconnect();
                document.getElementById('status').innerText = "Disconnected";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('endBtn').disabled = true;
                document.getElementById('shareBtn').disabled = true;
                document.getElementById('host').disabled = false;
                document.getElementById('port').disabled = false;
            }
        });

        // Share Status
        document.getElementById('shareBtn').addEventListener('click', () => {
            getGeoJSON((geojson) => {
                const message = new Paho.MQTT.Message(JSON.stringify(geojson));
                message.destinationName = TOPIC;
                client.send(message);
                document.getElementById('status').innerText = "Status shared";
                updateMap(geojson); // Update map immediately
            });
        });
    </script>
</body>
</html>
